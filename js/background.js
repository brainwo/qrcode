let options=Object.assign({ecl:"M",moduleSize:4,openUrl:"ask",autoclose:!0,whiteIcon:!1,sendUsageStats:!1},JSON.parse(localStorage.getItem("options")));const Message={alert(e){e=e.replace(/\n/,"\\n"),browser.tabs.executeScript({code:`alert('${e}')`})},prompt(e,t,o){browser.tabs.executeScript({code:`prompt('${e}', '${t}')`}).then(e=>e[0]&&o&&o())}},App={test(e,t){let o;t=t||4;try{o=qrcodeGenerator(t,options.ecl),o.addData(e),o.make(),o.createImgTag(options.moduleSize,options.moduleSize)}catch(o){return t<20?this.test(e,t+2):{error:o.message}}return{tn:t}},generate(e){const t=["linkUrl","selectionText","srcUrl","frameUrl","pageUrl"].find(t=>e[t]),o=e[t];this.openWindow(o),options.sendUsageStats},scan(e){qrcode.decode(e.srcUrl),options.sendUsageStats},openWindow(e){const t=this.test(e);if(t.error)Message.alert(`${chrome.i18n.getMessage("generate_error")}\n${t.error}`);else if(this.window)chrome.tabs.sendMessage(this.window.tabId,{data:e,tn:t.tn}),chrome.windows.update(this.window.windowId,{focused:!0});else{const o=310,s=360;chrome.windows.create({url:"popup.html?mode=window",left:Math.round((screen.width-o)/2),top:Math.round((screen.height-s)/2),width:o,height:s+25,type:"popup"},o=>{this.window={windowId:o.id,tabId:o.tabs[0].id,data:{data:e,tn:t.tn}}})}}};window.onstorage=e=>{options=JSON.parse(e.newValue)},qrcode.callback=e=>{if("error decoding QR Code"!==e){if(/^https?:\/\//i.test(e))switch(options.openUrl){case"ask":return void Message.prompt(chrome.i18n.getMessage("open"),e,()=>chrome.tabs.create({url:e}));case"auto":return void chrome.tabs.create({url:e})}Message.prompt(chrome.i18n.getMessage("result"),e)}else Message.alert(chrome.i18n.getMessage("scan_error"))},chrome.contextMenus&&(chrome.contextMenus.create({title:chrome.i18n.getMessage("generate"),contexts:["page","selection","link","image","video","audio"],onclick:App.generate.bind(App)}),chrome.contextMenus.create({title:chrome.i18n.getMessage("scan"),contexts:["image"],onclick:App.scan.bind(App)})),chrome.tabs.onUpdated.addListener(e=>{options.whiteIcon&&chrome.pageAction.setIcon({tabId:e,path:{16:"icon/16_w.png",32:"icon/32_w.png"}}),chrome.pageAction.show(e)}),chrome.tabs.onRemoved.addListener(e=>{App.window&&e===App.window.tabId&&(App.window=null)}),chrome.runtime.onMessage.addListener((e,t)=>{"requestData"===e.type&&chrome.tabs.sendMessage(t.tab.id,App.window.data)});var _gaq=_gaq||[];options.sendUsageStats;